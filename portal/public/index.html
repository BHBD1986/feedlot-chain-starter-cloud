<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Feedlot Chain Data Entry</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 18px; max-width: 900px; }
    label { display:block; margin-top:10px; font-weight:600; }
    input, select, textarea, button { width: 100%; padding: 8px; margin-top: 4px; }
    textarea { height: 120px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    .row { display:flex; gap: 12px; }
    .row > div { flex: 1; }
    .box { border:1px solid #ddd; padding:12px; border-radius:8px; margin-top:12px; }
    .ok { color: #0a7a0a; }
    .bad { color: #b00020; }
    code { background:#f5f5f5; padding:2px 4px; border-radius:4px; }
  </style>
</head>
<body>

<h2>Feedlot Ledger – Data Entry Portal</h2>

<div class="box">
  <div id="status">Checking status...</div>
</div>

<div class="box">
  <div class="row">
    <div>
      <label>Role (Group)</label>
      <select id="role">
        <option>FEEDLOT</option>
        <option>SCALE</option>
        <option>VET</option>
        <option>NUTRITION</option>
        <option>TRUCK</option>
        <option>PACKER</option>
      </select>
    </div>
    <div>
      <label>Event Type</label>
      <select id="eventType"></select>
    </div>
  </div>

  <label>CCIA Tag</label>
  <input id="tag" placeholder="124000123456789" />

  <label>Payload (JSON)</label>
  <textarea id="payload">{}</textarea>

  <button onclick="submitEvent()">Submit to Blockchain</button>

  <label>Group PIN</label>
  <input id="pin" type="password" placeholder="Enter your group PIN" />


  <div id="result" style="margin-top:12px;"></div>
</div>

<script>
const eventsByRole = {
  FEEDLOT: ["ANIMAL_REGISTERED","ARRIVAL_RECORDED","PEN_MOVED","SHIP_OUT"],
  SCALE: ["WEIGH_IN","WEIGH_OUT","WEIGH_VOIDED"],
  VET: ["TREATMENT_ADMINISTERED","TREATMENT_VOIDED"],
  NUTRITION: ["RATION_DEFINED","RATION_ASSIGNED","FEED_DELIVERED"],
  TRUCK: ["PICKUP_RECORDED","DELIVERY_RECORDED"],
  PACKER: ["RECEIVED_AT_PACKER"]
};

function refreshEventTypes() {
  const role = document.getElementById("role").value;
  const sel = document.getElementById("eventType");
  sel.innerHTML = "";
  for (const t of eventsByRole[role] || []) {
    const opt = document.createElement("option");
    opt.textContent = t;
    sel.appendChild(opt);
  }
}

document.getElementById("role").addEventListener("change", refreshEventTypes);
refreshEventTypes();

async function status() {
  const el = document.getElementById("status");
  try {
    const r = await fetch("/api/status", { cache: "no-store" });
    const j = await r.json();
    if (!j.ok) throw new Error(j.error || "status failed");
    el.innerHTML =
      `<span class="ok">OK</span> | RPC <code>${j.rpc}</code> | Contract <code>${j.contract}</code> | Block <code>${j.blockNumber}</code>`;
  } catch (e) {
    el.innerHTML = `<span class="bad">Offline</span> | ${e}`;
  }
}

async function submitEvent() {
  const role = document.getElementById("role").value;
  const eventType = document.getElementById("eventType").value;
  const tag = document.getElementById("tag").value.trim();
  const payloadText = document.getElementById("payload").value.trim();
  const pin = document.getElementById("pin").value;
  const result = document.getElementById("result");
  result.textContent = "";

  if (!tag) {
    result.innerHTML = `<span class="bad">Error:</span> Tag is required`;
    return;
  }

  let payload;
  try {
    payload = payloadText ? JSON.parse(payloadText) : {};
  } catch (e) {
    result.innerHTML = `<span class="bad">Payload JSON invalid:</span> ${e}`;
    return;
  }

  try {
    const r = await fetch("/api/submit", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ role, pin, tag, eventType, payload }),
      cache: "no-store"
    });

    const j = await r.json();
    if (!j.ok) throw new Error(j.error || "submit failed");

    result.innerHTML =
      `<div class="ok">Submitted!</div>
       <div>TX: <code>${j.txHash}</code></div>
       <div>Submitted By: <code>${j.submittedBy}</code></div>
       <div>Block: <code>${j.blockNumber}</code></div>`;

    // ✅ Refresh the status bar so the displayed block updates
    await status();

  } catch (e) {
    result.innerHTML = `<span class="bad">Error:</span> ${e}`;
  }
}

// initial status + keep it fresh for the classroom vibe
status();
setInterval(status, 3000);
</script>


</body>
</html>
